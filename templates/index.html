<!DOCTYPE html>
<html>
<head>
  <title>FullFight.AI</title>
</head>
<body>
  <h1>FullFight.AI</h1>
  <form id="fightForm">
    <input type="text" id="query" placeholder="e.g., Naruto vs Pain" required />
    <button type="submit">Parse Fight</button>
  </form>

  <form id="uploadForm" enctype="multipart/form-data">
    <input type="file" name="files" multiple required />
    <button type="submit">Upload Episodes</button>
  </form>

  <button id="compileBtn">Compile Fight</button>

  <div id="result"></div>

  <script>
    let animeData = {};
    let uploadedFiles = [];

    document.getElementById("fightForm").onsubmit = async (e) => {
      e.preventDefault();
      const query = document.getElementById("query").value;
      const res = await fetch("/parse_fight", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({query})
      });
      animeData = await res.json();
      console.log("Parsed:", animeData);
    };

    document.getElementById("uploadForm").onsubmit = async (e) => {
      e.preventDefault();
      const form = new FormData(document.getElementById("uploadForm"));
      const res = await fetch("/upload_episodes", { method: "POST", body: form });
      const data = await res.json();
      uploadedFiles = data.saved_files.map(f => f.split("/").pop());
      console.log("Uploaded:", uploadedFiles);
    };

    document.getElementById("compileBtn").onclick = async () => {
      const tsRes = await fetch("/get_timestamps", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(animeData)
      });
      const { timestamps } = await tsRes.json();

      const compileRes = await fetch("/compile_fight", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ timestamps, video_files: uploadedFiles })
      });

      const data = await compileRes.json();
      const videoUrl = `/output/${data.output_file}`;
      document.getElementById("result").innerHTML =
        `<video src="${videoUrl}" controls width="600"></video>`;
    };
  </script>
</body>
</html>
